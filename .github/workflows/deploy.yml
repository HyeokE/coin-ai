name: Deploy to Oracle Cloud

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Oracle Cloud
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ${{ secrets.OCI_USERNAME }}
          key: ${{ secrets.OCI_SSH_KEY }}
          port: ${{ secrets.OCI_PORT || 22 }}
          script: |
            set -e  # Exit on error
            
            # Load environment (nvm, pnpm, pm2)
            export NVM_DIR="$HOME/.nvm"
            
            # Install nvm if not exists
            if [ ! -d "$NVM_DIR" ]; then
              echo "ðŸ“¦ Installing nvm..."
              curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash || {
                echo "âš ï¸ nvm installation failed, trying alternative method..."
                # Fallback: try installing Node.js directly via NodeSource
                curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash - || {
                  echo "âŒ Failed to install Node.js. Please install manually."
                  exit 1
                }
                sudo apt-get install -y nodejs || {
                  echo "âŒ Failed to install Node.js via apt."
                  exit 1
                }
              }
              export NVM_DIR="$HOME/.nvm"
            fi
            
            # Load nvm (if installed)
            if [ -d "$NVM_DIR" ] && [ -s "$NVM_DIR/nvm.sh" ]; then
              \. "$NVM_DIR/nvm.sh"
            fi
            
            # Load shell configs (non-blocking)
            [ -s "$HOME/.bashrc" ] && source "$HOME/.bashrc" 2>/dev/null || true
            [ -s "$HOME/.profile" ] && source "$HOME/.profile" 2>/dev/null || true
            [ -s "$HOME/.zshrc" ] && source "$HOME/.zshrc" 2>/dev/null || true
            
            # Ensure Node.js is available
            if ! command -v node &> /dev/null; then
              echo "ðŸ“¦ Node.js not found. Installing Node.js 20..."
              if [ -s "$NVM_DIR/nvm.sh" ]; then
                \. "$NVM_DIR/nvm.sh"
                nvm install 20
                nvm use 20
                nvm alias default 20
              else
                echo "âŒ Failed to load nvm. Please install Node.js manually."
                exit 1
              fi
            fi
            
            # Verify Node.js installation
            if ! command -v node &> /dev/null; then
              echo "âŒ Node.js installation failed. Please install Node.js manually."
              exit 1
            fi
            
            echo "âœ… Node.js version: $(node --version)"
            echo "âœ… npm version: $(npm --version)"
            
            # Ensure pnpm is available
            if ! command -v pnpm &> /dev/null; then
              echo "âš ï¸ pnpm not found in PATH. Installing globally..."
              npm install -g pnpm || {
                echo "âŒ Failed to install pnpm"
                exit 1
              }
            fi
            
            # Ensure PM2 is available
            if ! command -v pm2 &> /dev/null; then
              echo "âš ï¸ PM2 not found in PATH. Installing globally..."
              npm install -g pm2 || {
                echo "âŒ Failed to install PM2"
                exit 1
              }
            fi
            
            # Create project directory if it doesn't exist
            PROJECT_DIR="$HOME/auto-coin"
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "ðŸ“ Creating project directory..."
              mkdir -p "$PROJECT_DIR"
              cd "$PROJECT_DIR"
              
              # Clone repository if not a git repo
              if [ ! -d ".git" ]; then
                echo "ðŸ“¥ Cloning repository..."
                git clone https://github.com/${{ github.repository }}.git .
              fi
            else
              cd "$PROJECT_DIR"
            fi
            
            # Ensure it's a git repository
            if [ ! -d ".git" ]; then
              echo "âŒ Not a git repository. Initializing..."
              git init
              git remote add origin https://github.com/${{ github.repository }}.git || true
            fi
            
            echo "ðŸ“¥ Pulling latest code..."
            git fetch origin main || git fetch origin master
            git reset --hard origin/main || git reset --hard origin/master
            
            # Create logs directory
            mkdir -p logs
            
            echo "ðŸ” Creating .env file..."
            cat > .env << 'EOF'
            UPBIT_ACCESS_KEY=${{ secrets.UPBIT_ACCESS_KEY }}
            UPBIT_SECRET_KEY=${{ secrets.UPBIT_SECRET_KEY }}
            DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}
            SUPABASE_URL=${{ secrets.SUPABASE_URL }}
            SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
            SYMBOLS=${{ secrets.SYMBOLS }}
            USE_WEBSOCKET=${{ secrets.USE_WEBSOCKET }}
            CANDLE_TYPE=${{ secrets.CANDLE_TYPE }}
            CANDLE_COUNT=${{ secrets.CANDLE_COUNT }}
            INTERVAL_MS=${{ secrets.INTERVAL_MS }}
            COOLDOWN_MS=${{ secrets.COOLDOWN_MS }}
            DASHBOARD_PORT=3001
            EOF

            echo "ðŸ“¦ Installing dependencies..."
            pnpm install --frozen-lockfile || pnpm install

            echo "ðŸ”¨ Building..."
            pnpm build

            echo "ðŸ”„ Restarting services with PM2..."
            pm2 restart ecosystem.config.js --update-env || pm2 start ecosystem.config.js

            echo "âœ… Deployment complete!"
            pm2 status
